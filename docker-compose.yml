---
# ============================================================================
# üê∞ CONEX√ÉO DE SORTE - RABBITMQ INFRAESTRUTURA
# ============================================================================
# Data de Cria√ß√£o: 17/09/2025 √†s 04:20 BRT
# √öltima Atualiza√ß√£o: 17/09/2025 √†s 04:20 BRT
# Respons√°vel: Sistema Automatizado
# Vers√£o: 1.0.0
# ============================================================================
#
# RABBITMQ STANDALONE - Message Broker
# - Docker Swarm deployment
# - Overlay encrypted network para seguran√ßa
# - Named volumes com placement constraints
# - Health checks otimizados para produ√ß√£o
# - Secrets externos gerenciados pelo Swarm
# ============================================================================

services:
  # ============================================================================
  # üê∞ RABBITMQ - Message Broker
  # ============================================================================
  rabbitmq:
    image: rabbitmq:4.1.0-management-alpine
    hostname: conexao-rabbitmq-production
    user: "999:999"
    init: true
    stop_grace_period: 60s
    environment:
      RABBITMQ_NODE_PORT: 5673
      RABBITMQ_MANAGEMENT_PORT: 15673
    secrets:
      - RABBITMQ_USERNAME
      - RABBITMQ_PASSWORD
    entrypoint:
      - bash
      - -c
      - |
        export RABBITMQ_DEFAULT_USER=$$(cat /run/secrets/RABBITMQ_USERNAME)
        export RABBITMQ_DEFAULT_PASS=$$(cat /run/secrets/RABBITMQ_PASSWORD)
        exec docker-entrypoint.sh rabbitmq-server
    networks:
      conexao-network-swarm:
        aliases:
          - conexao-rabbitmq-production
          - rabbitmq-production
          - conexao-rabbitmq
          - rabbitmq
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "5"
    ports:
      - "5673:5673"
      - "15673:15673"
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 150s
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: on-failure
        delay: 30s
        max_attempts: 5
        window: 300s
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        monitor: 30s
        order: start-first
      rollback_config:
        parallelism: 1
        monitor: 30s
        order: stop-first
      resources:
        limits:
          memory: 800M
        reservations:
          memory: 400M

# ============================================================================
# üì¶ VOLUMES EXTERNOS
# ============================================================================
volumes:
  rabbitmq_data:
    external: true
    name: rabbitmq_data

# ============================================================================
# üåê NETWORKS EXTERNOS
# ============================================================================
networks:
  conexao-network-swarm:
    external: true
    name: conexao-network-swarm

# ============================================================================
# üîê SECRETS EXTERNOS
# ============================================================================
secrets:
  RABBITMQ_USERNAME:
    external: true
    name: RABBITMQ_USERNAME
  RABBITMQ_PASSWORD:
    external: true
    name: RABBITMQ_PASSWORD